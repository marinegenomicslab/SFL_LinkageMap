---
title: "Comparative Genomics Southern Flounder"
output:
  html_notebook:
    code_folding: hide
    df_print: paged
    highlight: kate
    theme: flatly
    toc: yes
  html_document:
    toc: yes
---

```{r load libraries, message=FALSE, warning=FALSE}

knitr::opts_chunk$set(warning = FALSE, message = FALSE)

source("lib/libraries.R")
source("lib/ggplot.R")

```

# Family B Female Map

## Load data

Required inputfiles are `genfile`: `*.raw` generated using `convert.pl` to convert filtered `*.tsv`-output from haplotyper and `mapfile`: `*.map` text file with two columns (first column is putative linkage group, second column is markername). Need to create mapfile based on markers in genfile before analysis.

```{r, message=FALSE, warning=FALSE}

# load data
FamB_F <- read.cross("mm", dir="data/LINKMAP/", 
                     "FamB-F.raw", "FamB-F.map", estimate.map = FALSE)

# number of individuals/loci in data set
Sum_FamB_F.raw <- summary(FamB_F)
summary(FamB_F)
```
Raw data set contains `r as.numeric(Sum_FamB_F.raw$n.ind)` individuals and `r sum(as.numeric(Sum_FamB_F.raw$n.mar))` loci.

## Pre-mapping quality control

### Filter 1: Missing data

Missing genotypes (loci/individuals)

```{r}

# plot pattern of missing data
plotMissing(FamB_F)

```

Omit loci with > 5% missing data and individuals with > 25% missing data.

```{r, message=FALSE, warning=FALSE}

Nind_F.raw <- as.numeric(Sum_FamB_F.raw$n.ind)

# number of typed indivuals per locus
ntyped_F.l <- ntyped(FamB_F, "mar")
ntyped_F.l <- data.frame(LOCUS = names(ntyped_F.l), NTYPED = ntyped_F.l, row.names = NULL) %>%
  mutate(GENO = NTYPED/Nind_F.raw)

count(ntyped_F.l, GENO > 0.9)

# omit markers with >5% missing data
temp <- filter(ntyped_F.l, GENO < 0.9)
drop.l <- as.character(temp$LOCUS)
FamB_F.f1A <- drop.markers(FamB_F, drop.l)

# number of individuals/loci in data set
Sum_FamB_F.f1A <- summary(FamB_F.f1A)
Nind_F.f1A <- as.numeric(Sum_FamB_F.f1A$n.ind)
Nloci_F.f1A <- sum(as.numeric(Sum_FamB_F.f1A$n.mar))

# plot patterns of missing data after filter
par(mfrow=c(1,1))
plotMissing(FamB_F.f1A)

```

```{r}
# omit individuals with > 5% missing data
FamB_F.f1B <- subset(FamB_F.f1A, ind = (ntyped(FamB_F.f1A) > Nloci_F.f1A*0.85))

# number of individuals/loci in data set
Sum_FamB_F.f1B <- summary(FamB_F.f1B)
Nind_F.f1B <- as.numeric(Sum_FamB_F.f1B$n.ind)
Nloci_F.f1B <- sum(as.numeric(Sum_FamB_F.f1B$n.mar))

# plot patterns of missing data after filter
par(mfrow=c(1,1))
plotMissing(FamB_F.f1B)

```

After filtering data set contains `r Nind_F.f1B` individuals and `r Nloci_F.f1B` loci.

### Filter 2: Omit duplicate individuals

Compare genotypes of pairs of individuals to identify pairs with unusually similar genotypes

```{r}

# create matrix with proportion of matching genotypes for all pairs of individuals
cg <- comparegeno(FamB_F.f1B)

# plot proport. of matching genotypes
par(mfrow=c(1,1))
hist(cg[lower.tri(cg)], breaks=seq(0, 1, len=101), xlab="proportion of matching genotypes") 
rug(cg[lower.tri(cg)])

```

No matching individuals were identified.

```{r, message=FALSE, warning=FALSE}

# # identify pairs with over 90% matching genotypes
# match.i <- which(cg > 0.9, arr.ind=TRUE)
# match.i <- match.i[match.i[,1] < match.i[,2],] # table with row (genotype 1) and column (genotype 2) that were found to match in cg
# match.i 

# if no matching individuals identified
FamB_F.f2 <- FamB_F.f1

# number of individuals/loci in data set
Sum_FamB_F.f2 <- summary(FamB_F.f2)
Nind_F.f2 <- as.numeric(Sum_FamB_F.f2$n.ind)
Nloci_F.f2 <- sum(as.numeric(Sum_FamB_F.f2$n.mar))

```

Data set contains `r Nind_F.f2` individuals and `r Nloci_F.f2` loci.

### Filter 3: Omit duplicate markers

Identify matching markers. Drop duplicate markers but create table of corresponding marker to be mapped so the can be added post-mapping.

```{r, message=FALSE, warning=FALSE}

# identify matching markers (matching genotypes/including missing data)
match.loci <- findDupMarkers(FamB_F.f2, exact.only = TRUE)

# keep table to add markers back in after mapping
match.loci_F <- ldply(match.loci, data.frame) %>%
  rename(LOCUS = `.id`, MATCHLOC = `X..i..`)

write.table(match.loci_F, file = "data/LINKMAP/MatchLociFamBF.txt", 
            quote = FALSE, row.names = FALSE, sep = "\t")

# create list of matching loci
match.l <- as.character(match.loci_F$MATCHLOC) 

# drop duplicate markers
FamB_F.f3 <- drop.markers(FamB_F.f2, match.l)

# number of individuals/loci in data set
Sum_FamB_F.f3 <- summary(FamB_F.f3)
Nind_F.f3 <- as.numeric(Sum_FamB_F.f3$n.ind)
Nloci_F.f3 <- sum(as.numeric(Sum_FamB_F.f3$n.mar))

```

After filtering `r Nloci_F.f3` loci are retained.

### Filter 4: Drop loci with distroted segregation patterns

Loci should have specific segregation patterns based on marker type.

```{r, message=FALSE, warning=FALSE}

# calculate genotype frequencies and p-value (after Bonferroni correction)
geno.freq.l <- geno.table(FamB_F.f3)

# create list of markers with p-value <0.05
seg.dist.l <- geno.freq.l[geno.freq.l$P.value < 0.05/totmar(FamB_F.f3),] 
drop.l.seg.dist <- rownames(geno.freq.l[geno.freq.l$P.value < 1e-10,])

# drop markers with significant (p<0.05) deviation from expected segregation patterns
FamB_F.f4 <- drop.markers(FamB_F.f3, drop.l.seg.dist)

# number of individuals/loci in data set
Sum_FamB_F.f4 <- summary(FamB_F.f4)
Nind_F.f4 <- as.numeric(Sum_FamB_F.f4$n.ind)
Nloci_F.f4 <- sum(as.numeric(Sum_FamB_F.f4$n.mar))

```

After filtering `r Nloci_F.f4` loci are retained.

### Filter 5: Genotype frequencies by individual

Determine genotype frequencies by individual and remove individuals as necessary.

```{r, message=FALSE, warning=FALSE}

# determine genotype frequencies by individual
geno.frq.i <- pull.geno(FamB_F.f3)
gfreq.i <- apply(geno.frq.i, 1, function(a) table(factor(a, levels=1:3)))
gfreq.i <- t(t(gfreq.i) / colSums(gfreq.i))

# plot proportion of genotype (AA, AB, BB) for each individual
par(mfrow=c(1,3), las=1)
for(i in 1:3)
  plot(gfreq.i[i,], ylab="Genotype frequency", main=c("AA", "AB", "BB")[i], ylim=c(0,1))

# if no individuals removed
FamB_F.f5 <- FamB_F.f4

# number of individuals/loci in data set
Sum_FamB_F.f5 <- summary(FamB_F.f5)
Nind_F.f5 <- as.numeric(Sum_FamB_F.f5$n.ind)
Nloci_F.f5 <- sum(as.numeric(Sum_FamB_F.f5$n.mar))

```

After filtering `r Nind_F.f5` individuals are retained.

## Determine correct linkage phase

Estimate recombination fraction (rf) & LOD score for each marker pair. Potentially switched markers are pairs of marker with strong association (LOD score) but rf >> 1/4.

```{r, message=FALSE, warning=FALSE}

# estimate recombination fraction (rf) & LOD score for each marker pair
FamB_F.LP <- est.rf(FamB_F.f5)

# plot LOD score vs. rf
rf <- pull.rf(FamB_F.LP)
lod <- pull.rf(FamB_F.LP, what="lod")
par(mfrow=c(1,1))
plot(as.numeric(rf), as.numeric(lod), xlab="recombination fraction", ylab="LOD score")

```

Form initial linkage groups and re-organize loci into initial LGs.

```{r}

# form initial linkage groups
init.lg <- formLinkageGroups(FamB_F.LP, max.rf = 0.35, min.lod = 6)
table(init.lg[,2])

# re-organize markers into inferred initial LGs
FamB_F.LP <- formLinkageGroups(FamB_F.LP, max.rf = 0.35, min.lod = 6, reorgMarkers=TRUE)

```

Plot rf vs LOD to identify chromosomes to switch alleles for.

```{r, message=FALSE, warning=FALSE}

# plot rf vs LOD to see re-organized markers
par(mfrow=c(1,1))
plotRF(FamB_F.LP, alternate.chrid=TRUE)

```

Switch alleles, re-estimate rf, form new linkage groups and re-organize markers.

```{r}
# use plot to identify chromosomes to switch alleles for
for (chr in c(11, 14:16, 18, 22, 25, 28:29,
              31:34, 37:40, 42:48)){
  toswitch <- markernames(FamB_F.LP, chr=(chr))
  FamB_F.LP <- switchAlleles(FamB_F.LP, toswitch)
}

# re-estimate rf
FamB_F.LP <- est.rf(FamB_F.LP)

# form new linkage groups & re-organize markers
init.lg <- formLinkageGroups(FamB_F.LP, max.rf=0.35, min.lod=6)
table(init.lg[,2])
FamB_F.LP <- formLinkageGroups(FamB_F.LP, max.rf=0.35, min.lod=6, reorgMarkers=TRUE)

```

Plot rf vs LOD:

```{r}

# plot rf vs LOD to see re-organized markers
plotRF(FamB_F.LP, alternate.chrid=TRUE)

```

Drop marker in LG25:

```{r}

# if necessary identify outlier markers to drop
pull.map(FamB_F.LP, chr="25")
FamB_F.LP <- drop.markers(FamB_F.LP, c("dDocent_Contig_112677", "dDocent_Contig_55140"))
pull.map(FamB_F.LP, chr="26")
FamB_F.LP <- drop.markers(FamB_F.LP, c("dDocent_Contig_3380", "dDocent_Contig_57682"))
pull.map(FamB_F.LP, chr="27")
FamB_F.LP <- drop.markers(FamB_F.LP, c("dDocent_Contig_393412", "dDocent_Contig_39533"))
pull.map(FamB_F.LP, chr="28")
FamB_F.LP <- drop.markers(FamB_F.LP, "dDocent_Contig_13646")
pull.map(FamB_F.LP, chr="29")
FamB_F.LP <- drop.markers(FamB_F.LP, "dDocent_Contig_166471")
pull.map(FamB_F.LP, chr="30")
FamB_F.LP <- drop.markers(FamB_F.LP, "dDocent_Contig_18025")
pull.map(FamB_F.LP, chr="31")
FamB_F.LP <- drop.markers(FamB_F.LP, "dDocent_Contig_285352")
pull.map(FamB_F.LP, chr="32")
FamB_F.LP <- drop.markers(FamB_F.LP, "dDocent_Contig_9377")

# plot rf vs LOD to see re-organized markers
plotRF(FamB_F.LP, alternate.chrid=TRUE)

```

## Establish initial marker order

Establish initial marker order within LGs using greedy algorithm. Adds one marker at a time with previously added marker locations fixed. Position determined by minimizing number of obligate cross overs.

```{r}

# Create final cross/map object
FamB_F.final <- FamB_F.LP

# establish initial marker orders
FamB_F.final <- orderMarkers(FamB_F.final, chr=1:24)

```

## Initial quality assessment

### Examine pairwise linkage & Identify gaps between markers

Plot rf vs LOD after ordering markers:

```{r, message=FALSE, warning=FALSE}

# inspect pairwise linkage
par(ps = 12, cex.lab = 1)
plotRF(FamB_F.final, what = c("both"), alternate.chrid = TRUE, mark.diagonal = TRUE)

```

Large gaps between markers indicate that adjacent markers are only weakly linked. Compare average and largest spacing per LG.

```{r}

# compare average and largest spacing per LG
summaryMap(FamB_F.final)

```

```{r}
# plot maps of all chromosomes
par(ps=12, cex.lab=1)
plotMap(FamB_F.final, horizontal=FALSE, shift=TRUE, show.marker.names=FALSE, alternate.chrid=FALSE)

# plot map of specific chromosome (with contig names)
# par(mfrow=c(1,1), ps=12, cex.lab=1)
# plotMap(FamB_F.final, chr="", horizontal=FALSE, shift=TRUE, show.marker.names=TRUE, alternate.chrid=TRUE)

```

Drop markers one by one to determine change in chromosome length & change in log likelihood. Identify markers that result in smaller estimated chromosome length and increased LOD. Dropping terminal markers will usually result in decreased length.

```{r}
# drop each marker and compare effect
dropone <- droponemarker(FamB_F.final, maxit = 4000, tol = 1e-6, 
                         error.prob = 0.001, verbose = TRUE) %>%
  add_rownames("Marker") %>%
  gather("Effect", "Change", 4:5)

# plot results
plot_dropone <- function(dropone){
  p <- ggplot(dropone, aes(x = pos, y = Change)) +
    geom_line() +
    geom_point(shape = 21, size = 2,
               color = "black", fill = "white") +
    facet_grid(Effect ~ ., scales = "free") +
    labs(x = paste("LG", dropone$chr, "Position", sep =" "), y = "Change if marker dropped") +
    theme_facet
  print(p)
}

dropone %>%
  group_by(chr) %>%
  do(plot = plot_dropone(.)) %>%
  ungroup()

```

Compare effect in terms of change in length and likelihood and identify top 10 loci with strongest effect per LG.

```{r}

# data frame with top10 markers with strongest effect
dropone_sum <- dropone %>%
  spread("Effect", "Change") %>%
  group_by(chr) %>%
  top_n(10, LOD) %>%
  ungroup() %>%
  arrange(chr, LOD)

```

Drop markers as necessary and re-estimate map.

```{r}
# drop markers (LOD more positive, larger diff in likelihood)
FamB_F.final <- drop.markers(FamB_F.final, "dDocent_Contig_159654") # LG24
FamB_F.final <- drop.markers(FamB_F.final, "dDocent_Contig_13057") # LG24
FamB_F.final <- drop.markers(FamB_F.final, "dDocent_Contig_159654") # LG23
FamB_F.final <- drop.markers(FamB_F.final, "dDocent_Contig_295837") # LG23
FamB_F.final <- drop.markers(FamB_F.final, "dDocent_Contig_126887") # LG22
FamB_F.final <- drop.markers(FamB_F.final, "dDocent_Contig_84432") # LG22
FamB_F.final <- drop.markers(FamB_F.final, "dDocent_Contig_247420") # LG22
FamB_F.final <- drop.markers(FamB_F.final, "dDocent_Contig_21187") # LG22
FamB_F.final <- drop.markers(FamB_F.final, "dDocent_Contig_197704") # LG21
FamB_F.final <- drop.markers(FamB_F.final, "dDocent_Contig_134963") # LG21
FamB_F.final <- drop.markers(FamB_F.final, "dDocent_Contig_2978") # LG21
FamB_F.final <- drop.markers(FamB_F.final, "dDocent_Contig_121755") # LG20
FamB_F.final <- drop.markers(FamB_F.final, "dDocent_Contig_75380") # LG20
FamB_F.final <- drop.markers(FamB_F.final, "dDocent_Contig_59623") # LG20
FamB_F.final <- drop.markers(FamB_F.final, "dDocent_Contig_11361") # LG17
FamB_F.final <- drop.markers(FamB_F.final, "dDocent_Contig_203849") # LG17
FamB_F.final <- drop.markers(FamB_F.final, "dDocent_Contig_17094") # LG16
FamB_F.final <- drop.markers(FamB_F.final, "dDocent_Contig_31799") # LG16
FamB_F.final <- drop.markers(FamB_F.final, "dDocent_Contig_130447") # LG15
FamB_F.final <- drop.markers(FamB_F.final, "dDocent_Contig_305002") # LG14
FamB_F.final <- drop.markers(FamB_F.final, "dDocent_Contig_51748") # LG13
FamB_F.final <- drop.markers(FamB_F.final, "dDocent_Contig_4809") # LG10
FamB_F.final <- drop.markers(FamB_F.final, "dDocent_Contig_141878") # LG10
FamB_F.final <- drop.markers(FamB_F.final, "dDocent_Contig_82981") # LG10
FamB_F.final <- drop.markers(FamB_F.final, "dDocent_Contig_123865") # LG9
FamB_F.final <- drop.markers(FamB_F.final, "dDocent_Contig_4680") # LG9
FamB_F.final <- drop.markers(FamB_F.final, "dDocent_Contig_36090") # LG9
FamB_F.final <- drop.markers(FamB_F.final, "dDocent_Contig_2788") # LG8
FamB_F.final <- drop.markers(FamB_F.final, "dDocent_Contig_318298") # LG8
FamB_F.final <- drop.markers(FamB_F.final, "dDocent_Contig_1425") # LG7
FamB_F.final <- drop.markers(FamB_F.final, "dDocent_Contig_152405") # LG6
FamB_F.final <- drop.markers(FamB_F.final, "dDocent_Contig_325424") # LG4
FamB_F.final <- drop.markers(FamB_F.final, "dDocent_Contig_7480") # LG3
FamB_F.final <- drop.markers(FamB_F.final, "dDocent_Contig_39105") # LG2

# re-estimate map after eliminating markers
FamB_F.dropl <- est.map(FamB_F.final, error.prob=0.001)
FamB_F.final <- replace.map(FamB_F.final, FamB_F.dropl)

# plot maps of all chromosomes
summaryMap(FamB_F.final)

```

```{r}

par(ps=12, cex.lab=1)
plotMap(FamB_F.final, horizontal=FALSE, shift=TRUE, show.marker.names=FALSE, 
alternate.chrid=FALSE)

```

### Identify individuals with high number of XO

Observed number of crossovers per individual:

```{r, message=FALSE, warning=FALSE}

# observed number of crossovers per individual
par(mfrow=c(1,1), ps=12, cex=1)
plot(countXO(FamB_F.final), ylab="Number of crossover", xlab="individual")

```

Remove individuals with > 50 crossovers

```{r}

# # remove individuals with excessively high number of crossovers (< 50)
FamB_F.final <- subset(FamB_F.final, ind=(countXO(FamB_F.final) < 50))

```

### Estimate genotyping error rate

Estimate genotyping error rate.

```{r, message=FALSE, warning=FALSE}

# Estimate genotyping error rate
loglik <- err <- c(0.0001, 0.0005, 0.001, 0.0025, 0.005, 0.0075, 0.01, 0.015, 0.02)
for(i in seq(along=err)) {
  cat(i, "of", length(err), "\n")
  tempmap <- est.map(FamB_F.final, error.prob=err[i])
  loglik[i] <- sum(sapply(tempmap, attr, "loglik"))
}
lod <- (loglik - max(loglik))/log(10)

# plot log10 likelihood
par(mfrow=c(1,1), ps=12, cex=1)
plot(err, lod, xlab="Genotyping error rate", xlim=c(0,0.02), ylab=expression(paste(log[10], "likelihood")))

```

Genotyping error rate with highest likelihood is 0.0005.

### Identify genotyping errors and code as missing

Tight double-crossovers (single marker out of phase with adjacent markers) indicate genotyping errors. Identify double cross-overs by calculating genotyping error LOD scores (Lincoln & Lander 1992). Calculate errorload (genotype being in error vs not being in error). Plot grid of LOD scores indicating genotypes likely to be in error: darker pixels likely to be error: white (LOD <2), grey (2 < LOD < 3), pink (3 < LOD < 4.5), purple (LOD >4.5)

```{r, message=FALSE, warning=FALSE}

# produce list of genotypes with largest error LOD scores (added to cross object)
FamB_F.final <- calc.errorlod(FamB_F.final, error.prob = 0.005)

# plot grid of LOD scores indicating genotypes likely to be in error
# darker pixels likely to be error: white (LOD <2), grey (2 < LOD < 3), pink (3 < LOD < 4.5), purple (LOD >4.5)
plotErrorlod(FamB_F.final)

```

Eliminate genotypes (coded as missing) for LOD > 6 and re-estimate map.

```{r}
# determine cut-off (LOD > 6)
toperr <- top.errorlod(FamB_F.final, cutoff=6)

# look at genotypes flagged on selected chromosomes
# par(mfrow[1,1], ps=12, cex=1)
# plotGeno(FamB_F.final, chr=1, ind=toperr$id[toperr$chr==1], cutoff=6, include.xo=FALSE)

# eliminate genotypes if necessary (make them missing)
FamB_F.final <- FamB_F.final
for(i in 1:nrow(toperr)) {
  chr <- toperr$chr[i]
  id <- toperr$id[i]
  mar <- toperr$marker[i]
  FamB_F.final$geno[[chr]]$data[FamB_F$pheno$id==id, mar] <- NA
}

# re-estimate map
FamB_F.dropl <- est.map(FamB_F.final, error.prob = 0.001)
FamB_F.final <- replace.map(FamB_F.final, FamB_F.dropl)

```

`r nrow(toperr)` genotypes were coded as missing.

## Re-order markers by LG and compare alternate orders

### Compare number obligate XO, LOD & Chromosome length to determine best order

Re-order markers after loci and individuals have been removed and use sliding window to compare alternate orders in terms of number of obligate cross overs and likelihood.

```{r}

# compare number of obligate crossovers for alternate orders
FamB_F.XO <- lapply(c(1:24), function(chr) {
  rip <- ripple(FamB_F.final, chr = chr, window = 7, method="countxo", error.prob = 0.001, maxit = 2000, tol = 1e-6)
  rip <- rip[1:11,]
})

# access each element in list using [[]]
# Ch1_XO <- as.data.frame(FamB_F.XO[[1]]) %>%
#  rename(Chr1 = obligXO) %>%
#  select(Chr1)

FamB_F.lik <- lapply(c(1:24), function(chr) {
  rip.lik <- ripple(FamB_F.final, chr = chr, window = 5, method="likelihood", error.prob=0.002, maxit=2000, tol=1e-4)
  rip.lik <- rip.lik[1:11,]
})

```

### Switch marker order as necessary

Identify order with lowest number of XO and highest LOD while minimizing chromosome length.

```{r}

change.marker.order <- function(LG, neworder) {
  Orderlikelih <- as.data.frame(FamB_F.lik[[LG]]) %>%
    select(-LOD) %>%
    select(-chrlen)
  switch_marker <- as.numeric(Orderlikelih[3,])
  FamB_F.final <- switch.order(FamB_F.final, chr = LG, switch_marker, error.prob=0.001)
}

## LG1
# Identify order with lowest no. of XO & highest LOD while minimizing chromosome length
FamB_F.XO[[1]]
FamB_F.lik[[1]]
# change.marker.order(1, new)

## LG2 
FamB_F.XO[[2]]
FamB_F.lik[[2]]
change.marker.order(2, 1)

## LG3
FamB_F.XO[[3]]
FamB_F.lik[[3]]
# change.marker.order(3, 1)

## LG4
FamB_F.XO[[4]]
FamB_F.lik[[4]]
# change.marker.order(4, neworder)

## LG5
FamB_F.XO[[5]]
FamB_F.lik[[5]]
# change.marker.order(5, 2)

## LG6
FamB_F.XO[[6]]
FamB_F.lik[[6]]
# change.marker.order(6, neworder)

## LG7 
FamB_F.XO[[7]]
FamB_F.lik[[7]]
# change.marker.order(7, neworder)

## LG8
FamB_F.XO[[8]]
FamB_F.lik[[8]]
# change.marker.order(8, neworder)

## LG9
FamB_F.XO[[9]]
FamB_F.lik[[9]]
# change.marker.order(9, neworder)

## LG10
FamB_F.XO[[10]]
FamB_F.lik[[10]]
change.marker.order(10, 1)

## LG11
FamB_F.XO[[11]]
FamB_F.lik[[11]]
# change.marker.order(11, new)

## LG12
FamB_F.XO[[12]]
FamB_F.lik[[12]]
# change.marker.order(12, 1)

## LG13
FamB_F.XO[[13]]
FamB_F.lik[[13]]
# change.marker.order(13, new)

## LG14
FamB_F.XO[[14]]
FamB_F.lik[[14]]
# change.marker.order(14, new)

## LG15
FamB_F.XO[[15]]
FamB_F.lik[[15]]
change.marker.order(15, 1)

## LG16
FamB_F.XO[[16]]
FamB_F.lik[[16]]
# change.marker.order(16, neworder)

## LG17
FamB_F.XO[[17]]
FamB_F.lik[[17]]
# change.marker.order(17, neworder)

## LG18
FamB_F.XO[[18]]
FamB_F.lik[[18]]
# change.marker.order(18, 1)

## LG19
FamB_F.XO[[19]]
FamB_F.lik[[19]]
# change.marker.order(19, new)

## LG20
FamB_F.XO[[20]]
FamB_F.lik[[20]]
# change.marker.order(20, new)

## LG21
FamB_F.XO[[21]]
FamB_F.lik[[21]]
change.marker.order(21, 4)

## LG22
FamB_F.XO[[22]]
FamB_F.lik[[22]]
# change.marker.order(22, new)

## LG23
FamB_F.XO[[23]]
FamB_F.lik[[23]]
# change.marker.order(23, new)

## LG24
FamB_F.XO[[24]]
FamB_F.lik[[24]]
# change.marker.order(24, new)

# re-estimate map after re-ordering all LGs (chromosomes)
FamB_F.reorder <- est.map(FamB_F.final, error.prob = 0.001)

# re-place map portion of cross
FamB_F.reorder <- replace.map(FamB_F.final, FamB_F.reorder)

```

## Post-odering quality assessment II

### Examine pairwise linkage & Identify gaps between markers

Plot rf vs LOD

```{r}

# inspect pairwise linkage
plotRF(FamB_F.final)

```

Identify large gaps between markers which is indicative of adjacent markers being only weakly linked.

```{r}

# large gaps between markers indicate that adjacent markers are only weakly linked
summaryMap(FamB_F.final)

```

Plot maps of all linkage groups:

```{r}
# plot maps of all chromosomes
par(ps=12, cex.lab=1)
plotMap(FamB_F.final, horizontal=FALSE, shift=TRUE, show.marker.names=FALSE, alternate.chrid=FALSE)

```

Drop markers one by one determine change in chromosome length & change in log likelihood. Identify markers that result in smaller estimated chromosome length and increased LOD.

```{r}
# drop each marker and compare effect
dropone <- droponemarker(FamB_F.final, maxit = 4000, tol = 1e-6, 
                         error.prob = 0.001, verbose = TRUE) %>%
  add_rownames("Marker") %>%
  gather("Effect", "Change", 4:5)

# plot results
plot_dropone <- function(dropone){
  p <- ggplot(dropone, aes(x = pos, y = Change)) +
    geom_line() +
    geom_point(shape = 21, size = 2,
               color = "black", fill = "white") +
    facet_grid(Effect ~ ., scales = "free") +
    labs(x = paste("LG", dropone$chr, "Position", sep =" "), y = "Change if marker dropped") +
    theme_facet
  print(p)
}

dropone %>%
  group_by(chr) %>%
  do(plot = plot_dropone(.)) %>%
  ungroup()

```

Compare effect in terms of change in length and likelihood and identify top 10 loci with strongest effect per LG.

```{r}

# data frame with top10 markers with strongest effect
dropone_sum <- dropone %>%
  spread("Effect", "Change") %>%
  group_by(chr) %>%
  top_n(10, LOD) %>%
  ungroup() %>%
  arrange(chr, LOD)

```

```{r}

# drop markers (LOD more positive, larger diff in likelihood) 
FamB_F.final <- drop.markers(FamB_F.final, "") # LG

# re-estimate map after eliminating markers
FamB_F.dropl <- est.map(FamB_F.final, error.prob = 0.001)
FamB_F.final <- replace.map(FamB_F.final, FamB_F.dropl)

# plot maps of all chromosomes
par(ps=12, cex.lab=1)
plotMap(FamB_F.final, horizontal=FALSE, shift=TRUE, show.marker.names=FALSE, alternate.chrid=FALSE)

```

### Identify individuals with high number of XO

```{r}

# observed number of crossovers per individual
par(mfrow=c(1,1), ps=12, cex=1)
plot(countXO(FamB_F.final), ylab="Number of crossover", xlab="individual")

# # remove individuals with excessively high number of crossovers
# FamB_F.final <- subset(FamB_F.final, ind=(countXO(FamB_F.final) < 50))

```

## Finalize map

```{r}

# print summary map and map data
SummaryFamB_F <- summaryMap(FamB_F.final)

write.table(SummaryFamB_F, file = "results/SummaryFamB_F.map",
          quote = FALSE, sep = "\t", row.names = FALSE)

FamB_F.map <- pull.map(FamB_F.final,as.table = TRUE)

write.table(FamB_F.map, file = "data/LINKMAP/FamB_F.map",
            quote = FALSE, sep = "\t", row.names = TRUE)

```

Write files of finalized maps. Write files of finalized map. Map contains `r nrow(FamB_F.map)` loci grouped into 24 LG.

# Family B Male Map

## Load data

Required inputfiles are `genfile`: `*.raw` generated using `convert.pl` to convert filtered `*.tsv`-output from haplotyper and `mapfile`: `*.map` text file with two columns (first column is putative linkage group, second column is markername). Need to create mapfile based on markers in genfile before analysis.

```{r, message=FALSE, warning=FALSE}

# load data
FamB_M <- read.cross("mm", dir="data/LINKMAP/", 
                     "FamB-M.raw", "FamB-M.map", estimate.map = FALSE)

# number of individuals/loci in data set
Sum_FamB_M.raw <- summary(FamB_M)
Sum_FamB_M.raw

```
Raw data set contains `r as.numeric(Sum_FamB_M.raw$n.ind)` individuals and `r sum(as.numeric(Sum_FamB_M.raw$n.mar))` loci.

## Pre-mapping quality control

### Filter 1: Missing data

Missing genotypes (loci/individuals)

```{r}

# plot pattern of missing data
plotMissing(FamB_M)

```

Omit loci with > 5% missing data and individuals with > 25% missing data.

```{r, message=FALSE, warning=FALSE}

Nind_M.raw <- as.numeric(Sum_FamB_M.raw$n.ind)

# number of typed indivuals per locus
ntyped_M.l <- ntyped(FamB_M, "mar")
ntyped_M.l <- data.frame(LOCUS = names(ntyped_M.l), NTYPED = ntyped_M.l, row.names = NULL) %>%
  mutate(GENO = NTYPED/Nind_M.raw)

# omit markers with >5% missing data
temp <- filter(ntyped_M.l, GENO < 0.95)
drop.l <- as.character(temp$LOCUS)
FamB_M.f1 <- drop.markers(FamB_M, drop.l)

# omit individuals with > 5% missing data
Nloci_M.raw <- sum(as.numeric(Sum_FamB_M.raw$n.mar))

FamB_M.f1 <- subset(FamB_M.f1, ind = (ntyped(FamB_M.f1) > Nloci_M.raw*0.6))

# number of individuals/loci in data set
Sum_FamB_M.f1 <- summary(FamB_M.f1)
Nind_M.f1 <- as.numeric(Sum_FamB_M.f1$n.ind)
Nloci_M.f1 <- sum(as.numeric(Sum_FamB_M.f1$n.mar))

# plot patterns of missing data after filter
par(mfrow=c(1,1))
plotMissing(FamB_M.f1)

```

After filtering data set contains `r Nind_F.f1` individuals and `r Nloci_F.f1` loci.

### Filter 2: Omit duplicate individuals

Compare genotypes of pairs of individuals to identify pairs with unusually similar genotypes

```{r}

# create matrix with proportion of matching genotypes for all pairs of individuals
cg <- comparegeno(FamB_M.f1)

# plot proport. of matching genotypes
par(mfrow=c(1,1))
hist(cg[lower.tri(cg)], breaks=seq(0, 1, len=101), xlab="proportion of matching genotypes") 
rug(cg[lower.tri(cg)])

```

No matching individuals were identified.

```{r, message=FALSE, warning=FALSE}

# # identify pairs with over 90% matching genotypes
# match.i <- which(cg > 0.9, arr.ind=TRUE)
# match.i <- match.i[match.i[,1] < match.i[,2],] # table with row (genotype 1) and column (genotype 2) that were found to match in cg
# match.i 

# if no matching individuals identified
FamB_M.f2 <- FamB_M.f1

# number of individuals/loci in data set
Sum_FamB_M.f2 <- summary(FamB_M.f2)
Nind_M.f2 <- as.numeric(Sum_FamB_M.f2$n.ind)
Nloci_M.f2 <- sum(as.numeric(Sum_FamB_M.f2$n.mar))

```

Data set contains `r Nind_F.f2` individuals and `r Nloci_F.f2` loci.

### Filter 3: Omit duplicate markers

Identify matching markers. Drop duplicate markers but create table of corresponding marker to be mapped so the can be added post-mapping.

```{r, message=FALSE, warning=FALSE}

# identify matching markers (matching genotypes/including missing data)
match.loci <- findDupMarkers(FamB_M.f2, exact.only = TRUE)

# keep table to add markers back in after mapping
match.loci_M <- ldply(match.loci, data.frame) %>%
  rename(LOCUS = `.id`, MATCHLOC = `X..i..`)

write.table(match.loci_M, file = "data/LINKMAP/MatchLociFamBM.txt", 
            quote = FALSE, row.names = FALSE, sep = "\t")

# create list of matching loci
match.l <- as.character(match.loci_M$MATCHLOC) 

# drop duplicate markers
FamB_M.f3 <- drop.markers(FamB_M.f2, match.l)

# number of individuals/loci in data set
Sum_FamB_M.f3 <- summary(FamB_M.f3)
Nind_M.f3 <- as.numeric(Sum_FamB_M.f3$n.ind)
Nloci_M.f3 <- sum(as.numeric(Sum_FamB_M.f3$n.mar))

```

After filtering `r Nloci_M.f3` loci are retained.

### Filter 4: Drop loci with distroted segregation patterns

Loci should have specific segregation patterns based on marker type.

```{r, message=FALSE, warning=FALSE}

# calculate genotype frequencies and p-value (after Bonferroni correction)
geno.freq.l <- geno.table(FamB_M.f3)

# create list of markers with p-value <0.05
seg.dist.l <- geno.freq.l[geno.freq.l$P.value < 0.05/totmar(FamB_M.f3),] 
drop.l.seg.dist <- rownames(geno.freq.l[geno.freq.l$P.value < 1e-10,])

# drop markers with significant (p<0.05) deviation from expected segregation patterns
FamB_M.f4 <- drop.markers(FamB_M.f3, drop.l.seg.dist)

# number of individuals/loci in data set
Sum_FamB_M.f4 <- summary(FamB_M.f4)
Nind_M.f4 <- as.numeric(Sum_FamB_M.f4$n.ind)
Nloci_M.f4 <- sum(as.numeric(Sum_FamB_M.f4$n.mar))

```

After filtering `r Nloci_F.f4` loci are retained.

### Filter 5: Genotype frequencies by individual

Determine genotype frequencies by individual and remove individuals as necessary.

```{r, message=FALSE, warning=FALSE}

# determine genotype frequencies by individual
geno.frq.i <- pull.geno(FamB_M.f3)
gfreq.i <- apply(geno.frq.i, 1, function(a) table(factor(a, levels=1:3)))
gfreq.i <- t(t(gfreq.i) / colSums(gfreq.i))

# plot proportion of genotype (AA, AB, BB) for each individual
par(mfrow=c(1,3), las=1)
for(i in 1:3)
  plot(gfreq.i[i,], ylab="Genotype frequency", main=c("AA", "AB", "BB")[i], ylim=c(0,1))

# if no individuals removed
FamB_M.f5 <- FamB_M.f4

# number of individuals/loci in data set
Sum_FamB_M.f5 <- summary(FamB_M.f5)
Nind_M.f5 <- as.numeric(Sum_FamB_M.f5$n.ind)
Nloci_M.f5 <- sum(as.numeric(Sum_FamB_M.f5$n.mar))

```

After filtering `r Nind_M.f5` individuals are retained.

## Determine correct linkage phase

Estimate recombination fraction (rf) & LOD score for each marker pair. Potentially switched markers are pairs of marker with strong association (LOD score) but rf >> 1/4.

```{r, message=FALSE, warning=FALSE}

# estimate recombination fraction (rf) & LOD score for each marker pair
FamB_M.LP <- est.rf(FamB_M.f5)

# plot LOD score vs. rf
rf <- pull.rf(FamB_M.LP)
lod <- pull.rf(FamB_M.LP, what="lod")
par(mfrow=c(1,1))
plot(as.numeric(rf), as.numeric(lod), xlab="recombination fraction", ylab="LOD score")

```

Form initial linkage groups and re-organize loci into initial LGs.

```{r}

# form initial linkage groups
init.lg <- formLinkageGroups(FamB_M.LP, max.rf = 0.35, min.lod = 6)
table(init.lg[,2])

# re-organize markers into inferred initial LGs
FamB_M.LP <- formLinkageGroups(FamB_M.LP, max.rf = 0.35, min.lod = 6, reorgMarkers=TRUE)

```

Plot rf vs LOD to identify chromosomes to switch alleles for.

```{r, message=FALSE, warning=FALSE}

# plot rf vs LOD to see re-organized markers
par(mfrow=c(1,1))
plotRF(FamB_M.LP, alternate.chrid=TRUE)

```

Switch alleles, re-estimate rf, form new linkage groups and re-organize markers.

```{r}
# use plot to identify chromosomes to switch alleles for
for (chr in c(8, 12:14, 16, 18,
              21:23, 32:33, 35, 37:48)){
  toswitch <- markernames(FamB_M.LP, chr=(chr))
  FamB_M.LP <- switchAlleles(FamB_M.LP, toswitch)
}

# re-estimate rf
FamB_M.LP <- est.rf(FamB_M.LP)

# form new linkage groups & re-organize markers
init.lg <- formLinkageGroups(FamB_M.LP, max.rf=0.35, min.lod=6)
table(init.lg[,2])
FamB_M.LP <- formLinkageGroups(FamB_M.LP, max.rf=0.35, min.lod=6, reorgMarkers=TRUE)

```

Plot rf vs LOD after switching alleles:

```{r}

# plot rf vs LOD to see re-organized markers
plotRF(FamB_M.LP, alternate.chrid=TRUE)

```

Drop marker in LG25 and 26:

```{r}

# if necessary identify outlier markers to drop
pull.map(FamB_M.LP, chr="25")
pull.map(FamB_M.LP, chr="26")
FamB_M.LP <- drop.markers(FamB_M.LP, c("dDocent_Contig_211176", "dDocent_Contig_25489"))

```

## Establish initial marker order

Establish initial marker order within LGs using greedy algorithm. Adds one marker at a time with previously added marker locations fixed. Position determined by minimizing number of obligate cross overs.

```{r}

# Create final cross/map object
FamB_M.final <- FamB_M.LP

# establish initial marker orders
FamB_M.final <- orderMarkers(FamB_M.final, chr=1:24)

```

## Initial quality assessment

### Examine pairwise linkage & Identify gaps between markers

Plot rf vs LOD after ordering markers:

```{r, message=FALSE, warning=FALSE}

# inspect pairwise linkage
par(ps = 12, cex.lab = 1)
plotRF(FamB_M.final, what = c("both"), alternate.chrid = TRUE, mark.diagonal = TRUE)

```

Large gaps between markers indicate that adjacent markers are only weakly linked. Compare average and largest spacing per LG.

```{r}

# compare average and largest spacing per LG
summaryMap(FamB_M.final)

```

```{r}
# plot maps of all chromosomes
par(ps=12, cex.lab=1)
plotMap(FamB_M.final, horizontal=FALSE, shift=TRUE, show.marker.names=FALSE, alternate.chrid=FALSE)

```

Drop markers one by one to determine change in chromosome length & change in log likelihood. Identify markers that result in smaller estimated chromosome length and increased LOD. Dropping terminal markers will usually result in decreased length.

```{r}
# drop each marker and compare effect
dropone <- droponemarker(FamB_M.final, maxit = 4000, tol = 1e-6, 
                         error.prob = 0.001, verbose = TRUE) %>%
  add_rownames("Marker") %>%
  gather("Effect", "Change", 4:5)

# plot results
plot_dropone <- function(dropone){
  p <- ggplot(dropone, aes(x = pos, y = Change)) +
    geom_line() +
    geom_point(shape = 21, size = 2,
               color = "black", fill = "white") +
    facet_grid(Effect ~ ., scales = "free") +
    labs(x = paste("LG", dropone$chr, "Position", sep =" "), y = "Change if marker dropped") +
    theme_facet
  print(p)
}

dropone %>%
  group_by(chr) %>%
  do(plot = plot_dropone(.)) %>%
  ungroup()

```

Compare effect in terms of change in length and likelihood and identify top 10 loci with strongest effect per LG.

```{r}

# data frame with top10 markers with strongest effect
dropone_sum <- dropone %>%
  spread("Effect", "Change") %>%
  group_by(chr) %>%
  top_n(10, LOD) %>%
  ungroup() %>%
  arrange(chr, LOD)

```

Drop markers as necessary and re-estimate map.

```{r}

# drop markers (LOD more positive, larger diff in likelihood)
FamB_M.final <- drop.markers(FamB_M.final, "dDocent_Contig_271212") # LG24
FamB_M.final <- drop.markers(FamB_M.final, "dDocent_Contig_29936") # LG24
FamB_M.final <- drop.markers(FamB_M.final, "dDocent_Contig_255676") # LG24
FamB_M.final <- drop.markers(FamB_M.final, "dDocent_Contig_278198") # LG22
FamB_M.final <- drop.markers(FamB_M.final, "dDocent_Contig_285561") # LG17
FamB_M.final <- drop.markers(FamB_M.final, "dDocent_Contig_11919") # LG17
FamB_M.final <- drop.markers(FamB_M.final, "dDocent_Contig_62235") # LG16
FamB_M.final <- drop.markers(FamB_M.final, "dDocent_Contig_188592") # LG15
FamB_M.final <- drop.markers(FamB_M.final, "dDocent_Contig_134784") # LG15
FamB_M.final <- drop.markers(FamB_M.final, "dDocent_Contig_91847") # LG14
FamB_M.final <- drop.markers(FamB_M.final, "dDocent_Contig_1157") # LG14
FamB_M.final <- drop.markers(FamB_M.final, "dDocent_Contig_33950") # LG3

# re-estimate map after eliminating markers
FamB_M.dropl <- est.map(FamB_M.final, error.prob=0.001)
FamB_M.final <- replace.map(FamB_M.final, FamB_M.dropl)

# plot maps of all chromosomes
par(ps=12, cex.lab=1)
plotMap(FamB_M.final, horizontal=FALSE, shift=TRUE, show.marker.names=FALSE, alternate.chrid=FALSE)

```

### Identify individuals with high number of XO

Observed number of crossovers per individual; eliminate individuals with excessively high number of crossovers >50).

```{r, message=FALSE, warning=FALSE}

# observed number of crossovers per individual
par(mfrow=c(1,1), ps=12, cex=1)
plot(countXO(FamB_M.final), ylab="Number of crossover", xlab="individual")

# # remove individuals with excessively high number of crossovers (< 50)
# FamB_M.final <- subset(FamB_M.final, ind=(countXO(FamB_M.final) < 50))

```

### Estimate genotyping error rate

Estimate genotyping error rate.

```{r, message=FALSE, warning=FALSE}

# Estimate genotyping error rate
loglik <- err <- c(0.0001, 0.0005, 0.001, 0.0025, 0.005, 0.0075, 0.01, 0.015, 0.02)
for(i in seq(along=err)) {
  cat(i, "of", length(err), "\n")
  tempmap <- est.map(FamB_M.final, error.prob=err[i])
  loglik[i] <- sum(sapply(tempmap, attr, "loglik"))
}
lod <- (loglik - max(loglik))/log(10)

# plot log10 likelihood
par(mfrow=c(1,1), ps=12, cex=1)
plot(err, lod, xlab="Genotyping error rate", xlim=c(0,0.02), ylab=expression(paste(log[10], "likelihood")))

```

Genotyping error rate with highest likelihood is 0.0005.

### Identify genotyping errors and code as missing

Tight double-crossovers (single marker out of phase with adjacent markers) indicate genotyping errors. Identify double cross-overs by calculating genotyping error LOD scores (Lincoln & Lander 1992). Calculate errorload (genotype being in error vs not being in error). Plot grid of LOD scores indicating genotypes likely to be in error: darker pixels likely to be error: white (LOD <2), grey (2 < LOD < 3), pink (3 < LOD < 4.5), purple (LOD >4.5)

```{r, message=FALSE, warning=FALSE}

# produce list of genotypes with largest error LOD scores (added to cross object)
FamB_M.final <- calc.errorlod(FamB_M.final, error.prob = 0.0005)

# plot grid of LOD scores indicating genotypes likely to be in error
# darker pixels likely to be error: white (LOD <2), grey (2 < LOD < 3), pink (3 < LOD < 4.5), purple (LOD >4.5)
plotErrorlod(FamB_M.final)

```

Eliminate genotypes (coded as missing) for LOD > 6 and re-estimate map.

```{r}
# determine cut-off (LOD > 6)
toperr <- top.errorlod(FamB_M.final, cutoff=6)

# look at genotypes flagged on selected chromosomes
# par(mfrow[1,1], ps=12, cex=1)
# plotGeno(FamB_M.final, chr=1, ind=toperr$id[toperr$chr==1], cutoff=6, include.xo=FALSE)

# eliminate genotypes if necessary (make them missing)
FamB_M.final <- FamB_M.final
for(i in 1:nrow(toperr)) {
  chr <- toperr$chr[i]
  id <- toperr$id[i]
  mar <- toperr$marker[i]
  FamB_M.final$geno[[chr]]$data[FamB_M$pheno$id==id, mar] <- NA
}

# re-estimate map
FamB_M.dropl <- est.map(FamB_M.final, error.prob = 0.001)
FamB_M.final <- replace.map(FamB_M.final, FamB_M.dropl)

```

## Re-order markers by LG and compare alternate orders

### Compare number obligate XO, LOD & Chromosome length to determine best order

Re-order markers after loci and individuals have been removed and use sliding window to compare alternate orders in terms of number of obligate cross overs and likelihood.

```{r}

# compare number of obligate crossovers for alternate orders
FamB_M.XO <- lapply(c(1:24), function(chr) {
  rip <- ripple(FamB_M.final, chr = chr, window = 7, method="countxo", error.prob = 0.001, maxit = 2000, tol = 1e-6)
  rip <- rip[1:11,]
})

# access each element in list using [[]]
# Ch1_XO <- as.data.frame(FamB_M.XO[[1]]) %>%
#  rename(Chr1 = obligXO) %>%
#  select(Chr1)

FamB_M.lik <- lapply(c(1:24), function(chr) {
  rip.lik <- ripple(FamB_M.final, chr = chr, window = 5, method="likelihood", error.prob=0.002, maxit=2000, tol=1e-4)
  rip.lik <- rip.lik[1:11,]
})

```

### Switch marker order as necessary

Identify order with lowest number of XO and highest LOD while minimizing chromosome length.

```{r}

change.marker.order <- function(LG, neworder) {
  Orderlikelih <- as.data.frame(FamB_M.lik[[LG]]) %>%
    select(-LOD) %>%
    select(-chrlen)
  switch_marker <- as.numeric(Orderlikelih[3,])
  FamB_M.final <- switch.order(FamB_M.final, chr = LG, switch_marker, error.prob=0.001)
}

## LG1
# Identify order with lowest no. of XO & highest LOD while minimizing chromosome length
FamB_M.XO[[1]]
FamB_M.lik[[1]]
# change.marker.order(1, new)

## LG2 
FamB_M.XO[[2]]
FamB_M.lik[[2]]
# change.marker.order(2, 1)

## LG3
FamB_M.XO[[3]]
FamB_M.lik[[3]]
# change.marker.order(3, 1)

## LG4
FamB_M.XO[[4]]
FamB_M.lik[[4]]
# change.marker.order(4, neworder)

## LG5
FamB_M.XO[[5]]
FamB_M.lik[[5]]
# change.marker.order(5, 2)

## LG6
FamB_M.XO[[6]]
FamB_M.lik[[6]]
# change.marker.order(6, neworder)

## LG7 
FamB_M.XO[[7]]
FamB_M.lik[[7]]
# change.marker.order(7, neworder)

## LG8
FamB_M.XO[[8]]
FamB_M.lik[[8]]
# change.marker.order(8, neworder)

## LG9
FamB_M.XO[[9]]
FamB_M.lik[[9]]
# change.marker.order(9, neworder)

## LG10
FamB_M.XO[[10]]
FamB_M.lik[[10]]
# change.marker.order(10, 1)

## LG11
FamB_M.XO[[11]]
FamB_M.lik[[11]]
change.marker.order(11, 1)

## LG12
FamB_M.XO[[12]]
FamB_M.lik[[12]]
# change.marker.order(12, 1)

## LG13
FamB_M.XO[[13]]
FamB_M.lik[[13]]
# change.marker.order(13, new)

## LG14
FamB_M.XO[[14]]
FamB_M.lik[[14]]
# change.marker.order(14, new)

## LG15
FamB_M.XO[[15]]
FamB_M.lik[[15]]
# change.marker.order(15, 1)

## LG16
FamB_M.XO[[16]]
FamB_M.lik[[16]]
# change.marker.order(16, neworder)

## LG17
FamB_M.XO[[17]]
FamB_M.lik[[17]]
# change.marker.order(17, neworder)

## LG18
FamB_M.XO[[18]]
FamB_M.lik[[18]]
# change.marker.order(18, 1)

## LG19
FamB_M.XO[[19]]
FamB_M.lik[[19]]
# change.marker.order(19, new)

## LG20
FamB_M.XO[[20]]
FamB_M.lik[[20]]
# change.marker.order(20, new)

## LG21
FamB_M.XO[[21]]
FamB_M.lik[[21]]
# change.marker.order(21, 4)

## LG22
FamB_M.XO[[22]]
FamB_M.lik[[22]]
# change.marker.order(22, new)

## LG23
FamB_M.XO[[23]]
FamB_M.lik[[23]]
# change.marker.order(23, new)

## LG24
FamB_M.XO[[24]]
FamB_M.lik[[24]]
# change.marker.order(24, new)

# re-estimate map after re-ordering all LGs (chromosomes)
FamB_M.reorder <- est.map(FamB_M.final, error.prob = 0.001)

# re-place map portion of cross
FamB_M.reorder <- replace.map(FamB_M.final, FamB_M.reorder)

```

## Post-odering quality assessment II

### Examine pairwise linkage & Identify gaps between markers

Plot rf vs LOD

```{r}

# inspect pairwise linkage
plotRF(FamB_M.final)

```

Identify large gaps between markers which is indicative of adjacent markers being only weakly linked.

```{r}

# large gaps between markers indicate that adjacent markers are only weakly linked
summaryMap(FamB_M.final)

```

Plot maps of all linkage groups:

```{r}
# plot maps of all chromosomes
par(ps=12, cex.lab=1)
plotMap(FamB_M.final, horizontal=FALSE, shift=TRUE, show.marker.names=FALSE, alternate.chrid=FALSE)

```

Drop markers one by one determine change in chromosome length & change in log likelihood. Identify markers that result in smaller estimated chromosome length and increased LOD.

```{r}

# drop each marker and compare effect
dropone <- droponemarker(FamB_M.final, maxit = 4000, tol = 1e-6, 
                         error.prob = 0.001, verbose = TRUE) %>%
  add_rownames("Marker") %>%
  gather("Effect", "Change", 4:5)

# plot results
plot_dropone <- function(dropone){
  p <- ggplot(dropone, aes(x = pos, y = Change)) +
    geom_line() +
    geom_point(shape = 21, size = 2,
               color = "black", fill = "white") +
    facet_grid(Effect ~ ., scales = "free") +
    labs(x = paste("LG", dropone$chr, "Position", sep =" "), y = "Change if marker dropped") +
    theme_facet
  print(p)
}

dropone %>%
  group_by(chr) %>%
  do(plot = plot_dropone(.)) %>%
  ungroup()

```

Compare effect in terms of change in length and likelihood and identify top 10 loci with strongest effect per LG.

```{r}

# data frame with top10 markers with strongest effect
dropone_sum <- dropone %>%
  spread("Effect", "Change") %>%
  group_by(chr) %>%
  top_n(10, LOD) %>%
  ungroup() %>%
  arrange(chr, LOD)

```

```{r}

# drop markers (LOD more positive, larger diff in likelihood) 
FamB_M.final <- drop.markers(FamB_M.final, "dDocent_Contig_9840") # LG17
FamB_M.final <- drop.markers(FamB_M.final, "dDocent_Contig_87663") # LG16
FamB_M.final <- drop.markers(FamB_M.final, "dDocent_Contig_40559") # LG15
FamB_M.final <- drop.markers(FamB_M.final, "dDocent_Contig_42990") # LG14
FamB_M.final <- drop.markers(FamB_M.final, "dDocent_Contig_10941") # LG4

# re-estimate map after eliminating markers
FamB_M.dropl <- est.map(FamB_M.final, error.prob = 0.001)
FamB_M.final <- replace.map(FamB_M.final, FamB_M.dropl)

# plot maps of all chromosomes
par(ps=12, cex.lab=1)
plotMap(FamB_M.final, horizontal=FALSE, shift=TRUE, show.marker.names=FALSE, alternate.chrid=FALSE)

```

### Identify individuals with high number of XO

```{r}

# observed number of crossovers per individual
par(mfrow=c(1,1), ps=12, cex=1)
plot(countXO(FamB_M.final), ylab="Number of crossover", xlab="individual")

# # remove individuals with excessively high number of crossovers
# FamB_M.final <- subset(FamB_M.final, ind=(countXO(FamB_M.final) < 50))

```

## Finalize map

```{r}

# print summary map and map data
SummaryFamB_M <- summaryMap(FamB_M.final)

write.table(SummaryFamB_M, file = "results/SummaryFamB_M.map",
          quote = FALSE, sep = "\t", row.names = FALSE)

FamB_M.map <- pull.map(FamB_M.final,as.table = TRUE)

write.table(FamB_M.map, file = "data/LINKMAP/FamB_M.map",
            quote = FALSE, sep = "\t", row.names = TRUE)

```

Write files of finalized map. Map contains `r nrow(FamB_M.map)` loci grouped into 24 LG.

# Compare male/female maps

## Re-insert matching loci (same segregation pattern)

Finalize the female map by inserting the loci that had duplicate segregation patterns that were previously removed.

```{r}

# import female map
FamB_F.map <- read.table("data/LINKMAP/FamB_F.map", stringsAsFactors = FALSE, header = FALSE,
                         col.names = c("LOCUS", "LG_F", "POS_F"), skip = 1)

# add duplicate loci back in
match.loci_F <- read.table("data/LINKMAP/MatchLociFamBF.txt", header = TRUE,
                         stringsAsFactors = FALSE) %>%
  left_join(FamB_F.map) %>%
  select(MATCHLOC, LG_F, POS_F) %>%
  rename(LOCUS = MATCHLOC)

# update female map
FamB_F.map <- bind_rows(FamB_F.map, match.loci_F) %>%
  group_by(LG_F) %>%
  arrange(POS_F)

write.table(FamB_F.map, file = "results/FamB_F.map",
          quote = FALSE, sep = "\t", row.names = FALSE)

```

Finalize the male map by inserting the loci that had duplicate segregation patterns that were previously removed.

```{r}

# import male map
FamB_M.map <- read.table("data/LINKMAP/FamB_M.map", stringsAsFactors = FALSE, header = FALSE,
                         col.names = c("LOCUS", "LG_M", "POS_M"), skip = 1)

# add duplicate loci back in
match.loci_M <- read.table("data/LINKMAP/MatchLociFamBM.txt", header = TRUE,
                         stringsAsFactors = FALSE) %>%
  left_join(FamB_M.map) %>%
  select(MATCHLOC, LG_M, POS_M) %>%
  rename(LOCUS = MATCHLOC)

# update female map
FamB_M.map <- bind_rows(FamB_M.map, match.loci_M) %>%
  group_by(LG_M) %>%
  arrange(POS_M)

write.table(FamB_M.map, file = "results/FamB_M.map",
          quote = FALSE, sep = "\t", row.names = FALSE)

```

## Compare & join male/female maps

```{r}

# number of markers in maps
F.total <- as.numeric(nrow(FamB_F.map))
M.total <- as.numeric(nrow(FamB_M.map))

# number of shared markers
marker.shared <- inner_join(FamB_F.map, FamB_M.map, by = "LOCUS", copy = FALSE)
m.shared <- as.numeric(nrow(marker.shared))

# number of unique markers in each map
F.unique <- (F.total - m.shared)
M.unique <- (M.total - m.shared)

# Combine Female & Male maps (Marker, F_LG, F_LGPos, M_LG, M_LGPos)
marker.all <- full_join(FamB_F.map, FamB_M.map, by = "LOCUS", copy = FALSE) %>%
    ungroup()

# total number of mapped markers
m.total <- as.numeric(nrow(marker.all))

# overview of marker numbers
CAT <- c('F.TOTAL','M.TOTAL','M.SHARED', 'F.UNIQUE', 'M.UNIQUE', 'M.TOTAL')
N_MARKERS <- c(F.total, M.total, m.shared, F.unique, M.unique, m.total)
overview  <- data.frame(CAT, N_MARKERS)

# print output
write.table(marker.all, file = "results/FamB_allmarkers.txt")

# dataframe with all mapped markers
mapped_markers <- select(marker.all, LOCUS) %>%
  transmute(LOCUS = paste(c("*"), LOCUS, sep = ""))

```

For mapping Family B, the female and male maps contain `r F.total` and `r M.total` loci, respectively. Of those the `r m.shared` are shared, while the female and male maps contain `r F.unique` and `r M.unique` unique loci, respectively.

# FamB family map (onemap)

Map all loci segregating in male and/or female using full-cross.

## Filter onemap input file by markers in joined map data set

Import tab delimited onemap input file converted from filtered `*.tsv`-file using `map_convert.pl`.

```{r}

# change header names to Marker | Markertype | Genotype
FamB.onemap <- read.delim("data/LINKMAP/FamB.onemap", header = FALSE,
                          col.names = c("LOCUS", "LOCUSTYPE", "GENOTYPE"),
                          skip = 1, stringsAsFactors = FALSE)

# number of individuals in dataset
N <- read.delim("data/LINKMAP/FamB.onemap", header = FALSE,
                          col.names = c("N_IND", "N_LOCI"),
                          nrows = 1, stringsAsFactors = FALSE)

# keep only markers in combined data set (filter by joined data set)
Onemap.filtered <- semi_join(FamB.onemap, mapped_markers)

```

Unfiltered `onemap`-data set contains `r N$N_IND` individuals genotyped at `r N$N_LOCI` loci. After removing loci filtered during creation of male and female map, the data set consists of `nrow(Onemap.filtered)` loci.

Markers with matching genotypes (same segregation pattern) are removed and stored in table with corresponding loci retained in data set to insert after mapping loci.

```{r}

# remove duplicate genotypes
Onemap.filt2 <- Onemap.filtered %>%
  distinct(GENOTYPE, .keep_all = TRUE)

# create dataframe of removed loci and corresponding loci
match_loc <- anti_join(Onemap.filtered, Onemap.filt2) %>%
  rename(MATCHLOC = LOCUS) %>%
  select(MATCHLOC, GENOTYPE) %>% 
  left_join(Onemap.filt2, by = "GENOTYPE") %>%
  select(LOCUS, MATCHLOC)

# write filtered input file for Onemap
# need to add extra line back in
con <- file("data/LINKMAP/FamBfilter.onemap", open = "wt")
writeLines(paste(N$N_IND, (nrow(Onemap.filt2))), con)
write.table(Onemap.filt2, con, 
            append = FALSE, quote = FALSE, sep = " ", 
            na = "NA", dec = ".", 
            col.names = FALSE, row.names = FALSE)
close(con)

```

The filtered data set contains `r nrow(Onemap.filt2)` loci.

## Use onemap to create linkage map based on full-siblings

```{r}

# import datafile
FamB.Map <- read.outcross(file="data/LINKMAP/FamBfilter.onemap")

# Summary of datafile
FamB.Map

```

Estimate two-point recombination fractions between all pairs of markers (Wu et al. 2002). 

```{r}

# estimate recombination fraction between all pairs of markers
# creates object of class rf.2pts
FamB.Map.rf.L6.rf35 <- rf.2pts(FamB.Map, LOD = 6, max.rf = 0.35, verbose=TRUE)

```

Assign markers to linkage groups. Create sequence of all markers to assign to LGs and assign LG for LOD > 6 and rf < 0.35.

```{r}

# create sequence (list) of all markers to assign to LGs
all.markers <- make.seq(FamB.Map.rf.L6.rf35, "all") 

# assign markers to linkage groups
LGs <- group(all.markers, LOD = 6, max.rf = 0.35)

```

Markers are grouped into `r LGs$n.groups` LGs.

Map markers within linkage group using haldane mapping function. Onemap first creates a framework consisting of the most informative markers (segregating in both parents) and then maps the remaining markers.

```{r}

# define map function
set.map.fun(typ = "haldane")

# create list of separate LGs 
# (convert from class group to class sequence)
LG_list <- lapply(c(1:24), function(LG) {
  make.seq(LGs, LG)
})

# uses compare() to create a framework of most informative markers
# map remaining markers using try.seq()
# this step will take a few hours
LG_ordered <- lapply((LG_list), function(LG){
  order.seq(LG, n.init=6, THRES=3, touchdown=TRUE, tol=10e-2)
})

# create marker order with all markers
LG_final <- lapply((LG_ordered), function(LG){
  make.seq(LG, "force")
})

```

## Compare alternative marker sequences

Compare alternative sequences using ripple for 4 marker window. Make changes as needed (more positive LOD indicates better sequence).

```{r}

# compare and display alternative orders for LG1
# prints result of each window to screen
# more positive LOD indicates better sequence
# set window size using ws, LOD sets threshold for alt orders printed

# Start writing to an output file
sink("data/LINKMAP/ripple.onemap")

# run ripple for each LG
lapply((LG_final), function(LG){
  ripple.seq(LG, ws = 4, LOD = 3, tol = 10e-2)
})

# Stop writing to the file
sink()

# change marker order if necessary for each LG# using 
# LG#.new.seq <- make.seq(LGx.final, c())
# LG1.final <- map(LG#.new.seq)

```

Plot recombination fraction matrix to inspect linkage between mapped markers.

```{r}

# plot rf/LOD matrix
rf.graph.table(LG_final[[1]], inter = FALSE)

# # plot all rf/LOD matrices
# for (LG in c(1:24)){
#   rf.graph.table(LG_final[[LG]], inter = FALSE)
# }

```

## Draw linkage map and save results

```{r}

# group all final ordered LGs
FamB.map <- LG_final

# draw map for all LGs
draw.map(FamB.map, names=FALSE, grid=TRUE, cex.mrk=0.7)

# draw map for specific LG
# draw.map(FamB.map[[LG]], names=TRUE, grid=TRUE, cex.mrk=0.7) 

```

Add duplicate markers (with same genotype/segregation pattern) and save finalized map to file

```{r}

# export map to file
write.map(FamB.map, "data/LINKMAP/FamB.fullmap")
FamB.fullmap <- read.table("data/LINKMAP/FamB.fullmap", 
                           skip = 1, header = FALSE) %>%
  mutate(LOCUS = paste(c("*"), V2, sep = "")) %>%
  rename(LG = V1, POSITION = V3) %>%
  select(LOCUS, LG, POSITION)

# add mapping positions
temp <- left_join(match_loc, FamB.fullmap, by = "LOCUS") %>%
  select(MATCHLOC, LG, POSITION) %>%
  rename(LOCUS = MATCHLOC)

# add markers to final map
FamB.fullmap <- bind_rows(FamB.fullmap, temp) %>%
  group_by(LG) %>%
  arrange(POSITION) %>%
  ungroup()

# write output to file
write.table(FamB.fullmap, "results/FamB.fullmap", row.names = FALSE)

```
