---
title: "Comparative Genomics Southern Flounder"
output:
  html_notebook:
    code_folding: hide
    df_print: paged
    highlight: kate
    theme: flatly
    toc: yes
  html_document:
    toc: yes
---

```{r load libraries, message=FALSE, warning=FALSE}

knitr::opts_chunk$set(warning = FALSE, message = FALSE)

source("lib/libraries.R")
source("lib/ggplot.R")

```

# Load data

```{r}

# load map data
map <- read.table("data/SYNTENY/map.tab", 
                  header=TRUE, stringsAsFactors = FALSE)

# chrom lengths fish genomes
chrom <- read.table("data/SYNTENY/chr_lengths.txt", 
                    header = TRUE, stringsAsFactors = FALSE)

# load synteny data
syn_blocks <- read.table("data/SYNTENY/all.blocks.tab", 
                         header=TRUE, stringsAsFactors = FALSE)

# load synteny mapped loci
syn_loci <- read.table("data/SYNTENY/all.synteny.mapped.out",
                       header=TRUE, stringsAsFactors = FALSE)

```

# Write input files

## Karyotype files

Create karyotype file for southern flounder consensus map:

```{r}

# determine length of each LG
by_lg <- group_by(map, LG) %>%
  top_n(1, POS)

# format karyotype file
kary <- ungroup(by_lg) %>%
    select(LG, POS) %>%
    unique() %>% # not sure why some LGs are duplicates?
    mutate(COLOR = "black") %>%
    mutate(id = paste("lg", LG, sep=''), 
           label = paste("LG", LG, sep=''),
           chr = "chr", 
           dash = "-", 
           start = "0", 
           end = as.integer(POS*500000), 
           color = "black") %>%
    select(chr, dash, id, label, start, end, COLOR)

# output karyotype data file
write.table(kary, file = "data/SYNTENY/SFL.karyotype.txt", 
            sep = "\t", quote = FALSE, 
            row.names = FALSE, col.names = FALSE)

```

Create karyotype file for European seabass genome:

```{r}

# format file
kary <- chrom %>%
  filter(species == "dlab") %>%
  mutate(chr = "chr",
         dash = "-",
         id = chrom,
         label = chrom,
         start = "0", 
         end = length,
         color = "black") %>%
  select(chr, dash, id, label, start, end, color)

# write karyotype track file
write.table(kary, "data/SYNTENY/dlab.karyotype.txt",
              sep = "\t", quote = FALSE, row.names = FALSE, col.names = FALSE)

```

Create karyotype file for stickleback (gacu):

```{r}

# create data frame with chromosome lengths
kary <- chrom %>%
  filter(species == "gacu") %>%
  mutate(chr = "chr",
         dash = "-",
         id = chrom,
         label = chrom,
         start = "0", 
         end = length,
         color = "black") %>%
  select(chr, dash, id, label, start, end, color)

# write karyotype track file
write.table(kary, "data/SYNTENY/gacu.karyotype.txt",
            sep = "\t", quote = FALSE, row.names = FALSE, col.names = FALSE)
  
```

Create karyotype file for Asian seabass (lcal):

```{r}

# create data frame with chromosome lengths
kary <- chrom %>%
  filter(species == "lcal") %>%
  mutate(chr = "chr",
         dash = "-",
         id = chrom,
         label = chrom,
         start = "0", 
         end = length,
         color = "black") %>%
  select(chr, dash, id, label, start, end, color)

# write karyotype track file
write.table(kary, "data/SYNTENY/lcal.karyotype.txt",
            sep = "\t", quote = FALSE, row.names = FALSE, col.names = FALSE)

```

Create karyotype file for Nile tilapia (onil):

```{r}

# create data frame with chromosome lengths
kary <- chrom %>%
  filter(species == "onil") %>%
  mutate(chr = "chr",
         dash = "-",
         id = chrom,
         label = chrom,
         start = "0", 
         end = length,
         color = "black") %>%
  select(chr, dash, id, label, start, end, color)

# write karyotype track file
write.table(kary, "data/SYNTENY/onil.karyotype.txt",
            sep = "\t", quote = FALSE, row.names = FALSE, col.names = FALSE)

```

Create karyotype file for spotted green puffer (tnig):

```{r}

# create data frame with chromosome lengths
kary <- chrom %>%
  filter(species == "tnig") %>%
  mutate(chr = "chr",
         dash = "-",
         id = chrom,
         label = chrom,
         start = "0", 
         end = length,
         color = "black") %>%
  select(chr, dash, id, label, start, end, color)

# write karyotype track file
write.table(kary, "data/SYNTENY/tnig.karyotype.txt",
            sep = "\t", quote = FALSE, row.names = FALSE, col.names = FALSE)

```

Create karyotype file for fugu (trub):

```{r}

# create data frame with chromosome lengths
kary <- chrom %>%
  filter(species == "trub") %>%
  mutate(chr = "chr",
         dash = "-",
         id = chrom,
         label = chrom,
         start = "0", 
         end = length,
         color = "black") %>%
  select(chr, dash, id, label, start, end, color)

# write karyotype track file
write.table(kary, "data/SYNTENY/trub.karyotype.txt",
            sep = "\t", quote = FALSE, row.names = FALSE, col.names = FALSE)

```

## Tile track files

### Create markers file with positions of mapped loci on each linkage group (chromosome).

```{r}

markers <- map %>%
    mutate(chr = paste("lg", LG, sep=''),
           start = as.integer(POS*500000), 
           end = as.integer(POS*500000)) %>%
    select(chr, start, end)

write.table(markers, file = "data/SYNTENY/markers.txt", 
            sep = "\t", quote = FALSE, 
            row.names = FALSE, col.names = FALSE)

```

### Write tile track files for synteny blocks:

```{r}

# write tile track for synteny blocks for each species

species <- as.vector(unique(syn_blocks$COMP_SPECIES))

for (i in 1:length(species)) {
  
    tiles <- syn_blocks %>%
        filter(COMP_SPECIES == species[i]) %>%
        mutate(chr = paste("lg", MAP_LG, sep=''), 
               start = as.integer(MAP_START * 500000), 
               end = as.integer(MAP_STOP * 500000)) %>%
        select(chr, start, end)
    
    write.table(tiles, file = paste("data/SYNTENY/", species[i], ".synblocks", sep = ''), 
                sep = "\t", quote = FALSE, 
                row.names = FALSE, col.names = FALSE)
}

<<<<<<< Updated upstream
=======
```

### Write tile track files for synteny mapped loci

Format dataframe with information on synteny mapped loci to be able to filter individuals data sets.

```{r}

# fix formating of locus names
temp <- filter(syn_loci, grepl("gi*", LOCUS)) %>%
  separate(LOCUS, c("A", "B", "C", "D"), sep = "\\|") %>%
  rename(LOCUS = B) %>%
  select(-A, -C, -D)

# add back into synteny mapped loci data frame
syn_loci <- filter(syn_loci, !grepl("gi*", LOCUS))
syn_loci <- bind_rows(syn_loci, temp)

# # create dataframe with LOCUS and ACCESSION No. from FASTA file
# flounderloci_IDs <- read.delim("data/SYNTENY/flounderloci.txt", sep = "|", header = FALSE) %>%
#   rename(LOCUS = V2, ACCESSION = V4) %>%
#   separate(ACCESSION, c("ACCESSION", "temp"), sep = -3) %>%
#   select(LOCUS, ACCESSION)

flounderloci_IDs$LOCUS <- as.character(flounderloci_IDs$LOCUS)

# add accession numbers
syn_loci <- left_join(syn_loci, flounderloci_IDs)

```

**Williams et al 2003: Stress response in European flounder**

```{r}

# Williams et al 2003 stress resonse
# stress_response <- read.delim("data/SYNTENY/Stress_response_W03.txt",
#                              header = TRUE, stringsAsFactors = FALSE)

# add map data locus info
stress_response <- left_join(stress_response, syn_loci)

# write results
write.table(stress_response, "results/stress_response.loci")

# Write a tile file for the synteny mapped loci
stress_response <- stress_response %>%
    filter(!is.na(LOCUS)) %>%
    mutate(chr = paste("lg", LG, sep=''), 
           start = as.integer(LEFT_POS * 500000), 
           end = as.integer(RIGHT_POS * 500000)) %>%
    select(chr, start, end)

write.table(stress_response, file = "data/SYNTENY/stress_response.syn", 
            sep = "\t", quote = FALSE, 
            row.names = FALSE, col.names = FALSE)
```

**Williams et al. 2007 Estradiol exposure resonse** 

```{r}

# Williams et al. 2007 gene expression exposed to estradiol
# estradiol_response <- read.delim("data/SYNTENY/Estradiol_response_W07.txt",
#                                  header = TRUE, stringsAsFactors = FALSE)

# add map data locus info
estradiol_response <- left_join(estradiol_response, syn_loci)

# write results
write.table(estradiol_response, "results/estradiol_response.loci")

# Write a tile file for the synteny mapped loci
estradiol_response <- estradiol_response %>%
    filter(!is.na(LOCUS)) %>%
    mutate(chr = paste("lg", LG, sep=''), 
           start = as.integer(LEFT_POS * 500000), 
           end = as.integer(RIGHT_POS * 500000)) %>%
    select(chr, start, end)

write.table(estradiol_response, file = "data/SYNTENY/estradiol_response.syn", 
            sep = "\t", quote = FALSE, 
            row.names = FALSE, col.names = FALSE)

```

**Larsen et al. 2007 Salinity differences**

```{r}

# Larsen et al. 2007 gene expression salinity differences
# salinity_response <- read.delim("data/SYNTENY/Salinity_response_L07.txt",
#                                 header = TRUE, stringsAsFactors = FALSE)

# add map data locus info
salinity_response <- left_join(salinity_response, syn_loci)

# write results
write.table(salinity_response, "results/salinity_response.loci")

# Write a tile file for the synteny mapped loci
salinity_response <- salinity_response %>%
    filter(!is.na(LOCUS)) %>%
    mutate(chr = paste("lg", LG, sep=''), 
           start = as.integer(LEFT_POS * 500000), 
           end = as.integer(RIGHT_POS * 500000)) %>%
    select(chr, start, end)

write.table(salinity_response, file = "data/SYNTENY/salinity_response.syn", 
            sep = "\t", quote = FALSE, 
            row.names = FALSE, col.names = FALSE)

>>>>>>> Stashed changes
```

**Falciani et al. 2008 Pollutants response**

```{r}

# # Faciani et al. 2008 gene expression exposed to pollutants (lab and wild populations)
# pollutants_response <- read.delim("data/SYNTENY/Pollutants_response_F08.txt",
#                                   header = TRUE, stringsAsFactors = FALSE)

# add map data locus info
pollutants_response <- left_join(pollutants_response, syn_loci)

# write results
write.table(pollutants_response, "results/pollutants_response.loci")

# Write a tile file for the synteny mapped loci
pollutants_response <- pollutants_response %>%
    filter(!is.na(LOCUS)) %>%
    mutate(chr = paste("lg", LG, sep=''), 
           start = as.integer(LEFT_POS * 500000), 
           end = as.integer(RIGHT_POS * 500000)) %>%
    select(chr, start, end)

write.table(pollutants_response, file = "data/SYNTENY/pollutants_response.syn", 
            sep = "\t", quote = FALSE, 
            row.names = FALSE, col.names = FALSE)

```

**Song et al 2012. Linkage map japanese flounder**

```{r}

# microsatellite in linkage map (Japanese flounder)
# Japfl_linkmapI <- read.delim("data/SYNTENY/LinkMapI.txt",
#                             header = TRUE, stringsAsFactors = FALSE)

# add map data locus info
Japfl_linkmapI <- left_join(Japfl_linkmapI, syn_loci)

# write results
write.table(Japfl_linkmapI, "results/Japfl_linkmapI.loci")

# Write a tile file for the synteny mapped loci
Japfl_linkmapI <- Japfl_linkmapI %>%
    filter(!is.na(LOCUS)) %>%
    mutate(chr = paste("lg", LG, sep=''), 
           start = as.integer(LEFT_POS * 500000), 
           end = as.integer(RIGHT_POS * 500000)) %>%
    select(chr, start, end)

write.table(Japfl_linkmapI, file = "data/SYNTENY/Japfl_linkmapI.syn", 
            sep = "\t", quote = FALSE, 
            row.names = FALSE, col.names = FALSE)

```

**Castano-Sanchez et al. 2010 Linkage map japanese flounder**

```{r}

# Japfl_linkmapII <- read.delim("data/SYNTENY/LinkMapII.txt",
#                                header = TRUE, stringsAsFactors = FALSE)

# add map data locus info
Japfl_linkmapII <- left_join(Japfl_linkmapII, syn_loci)

# write results
write.table(Japfl_linkmapII, "results/Japfl_linkmapII.loci")

# Write a tile file for the synteny mapped loci
Japfl_linkmapII <- Japfl_linkmapII %>%
    filter(!is.na(LOCUS)) %>%
    mutate(chr = paste("lg", LG, sep=''), 
           start = as.integer(LEFT_POS * 500000), 
           end = as.integer(RIGHT_POS * 500000)) %>%
    select(chr, start, end)

<<<<<<< Updated upstream
write.table(syn_loci, file = "data/SYNTENY/all.synloci", 
=======
write.table(Japfl_linkmapII, file = "data/SYNTENY/Japfl_linkmapII.syn", 
>>>>>>> Stashed changes
            sep = "\t", quote = FALSE, 
            row.names = FALSE, col.names = FALSE)

```

## Write link files

Link file for synteny blocks dlab and SFL.

```{r}

# Format file
dlab_synblocks <- syn_blocks %>%
  filter(COMP_SPECIES == "dlab") %>%
  mutate(lg = paste("lg", MAP_LG, sep=''), 
         lgstart = as.integer(MAP_START * 500000),
         lgend = as.integer(MAP_STOP * 500000),
         chr = COMP_CHR,
         chrstart = COMP_START,
         chrend = COMP_END) %>%
  select(lg, lgstart, lgend, chr, chrstart, chrend)

write.table(dlab_synblocks, file = "data/SYNTENY/dlab.syn", 
                         sep = "\t", quote = FALSE, row.names = FALSE, col.names = FALSE)

```

Link file for synteny blocks gacu and SFL.

```{r}

# Format file
dlab_synblocks <- syn_blocks %>%
  filter(COMP_SPECIES == "gacu") %>%
  mutate(lg = paste("lg", MAP_LG, sep=''), 
         lgstart = as.integer(MAP_START * 500000),
         lgend = as.integer(MAP_STOP * 500000),
         chr = COMP_CHR,
         chrstart = COMP_START,
         chrend = COMP_END) %>%
  select(lg, lgstart, lgend, chr, chrstart, chrend) %>%
    group_by(lg)

write.table(dlab_synblocks, file = "data/SYNTENY/gacu.syn", 
                         sep = "\t", quote = FALSE, row.names = FALSE, col.names = FALSE)

```

Link file for synteny blocks lcal and SFL.

```{r}

# Format file
dlab_synblocks <- syn_blocks %>%
  filter(COMP_SPECIES == "lcal") %>%
  mutate(lg = paste("lg", MAP_LG, sep=''), 
         lgstart = as.integer(MAP_START * 500000),
         lgend = as.integer(MAP_STOP * 500000),
         chr = COMP_CHR,
         chrstart = COMP_START,
         chrend = COMP_END) %>%
  select(lg, lgstart, lgend, chr, chrstart, chrend) %>%
    group_by(lg)

write.table(dlab_synblocks, file = "data/SYNTENY/lcal.syn", 
                         sep = "\t", quote = FALSE, row.names = FALSE, col.names = FALSE)

```

Link file for synteny blocks onil and SFL.

```{r}

# Format file
dlab_synblocks <- syn_blocks %>%
  filter(COMP_SPECIES == "onil") %>%
  mutate(lg = paste("lg", MAP_LG, sep=''), 
         lgstart = as.integer(MAP_START * 500000),
         lgend = as.integer(MAP_STOP * 500000),
         chr = COMP_CHR,
         chrstart = COMP_START,
         chrend = COMP_END) %>%
  select(lg, lgstart, lgend, chr, chrstart, chrend) %>%
    group_by(lg)

write.table(dlab_synblocks, file = "data/SYNTENY/onil.syn", 
                         sep = "\t", quote = FALSE, row.names = FALSE, col.names = FALSE)

```

Link file for synteny blocks tnig and SFL.

```{r}

# Format file
dlab_synblocks <- syn_blocks %>%
  filter(COMP_SPECIES == "tnig") %>%
  mutate(lg = paste("lg", MAP_LG, sep=''), 
         lgstart = as.integer(MAP_START * 500000),
         lgend = as.integer(MAP_STOP * 500000),
         chr = COMP_CHR,
         chrstart = COMP_START,
         chrend = COMP_END) %>%
  select(lg, lgstart, lgend, chr, chrstart, chrend) %>%
    group_by(lg)

write.table(dlab_synblocks, file = "data/SYNTENY/tnig.syn", 
                         sep = "\t", quote = FALSE, row.names = FALSE, col.names = FALSE)

```

Link file for synteny blocks trub and SFL.

```{r}

# Format file
dlab_synblocks <- syn_blocks %>%
  filter(COMP_SPECIES == "trub") %>%
  mutate(lg = paste("lg", MAP_LG, sep=''), 
         lgstart = as.integer(MAP_START * 500000),
         lgend = as.integer(MAP_STOP * 500000),
         chr = COMP_CHR,
         chrstart = COMP_START,
         chrend = COMP_END) %>%
  select(lg, lgstart, lgend, chr, chrstart, chrend) %>%
    group_by(lg)

write.table(dlab_synblocks, file = "data/SYNTENY/trub.syn", 
                         sep = "\t", quote = FALSE, row.names = FALSE, col.names = FALSE)

```


# Run circos:

Plot synteny blocks (inside) and SNP loci (outside):

```{r}

system('perl "scr/circos-0.66/bin/circos" -conf data/SYNTENY/circos-synt_blocks.conf -outputdir fig -outputfile synteny-blocks')

```

Plot comparison location of synteny blocks lcal vs SFL

```{r}

system('perl "scr/circos-0.66/bin/circos" -conf data/SYNTENY/circos-synt_lcal.conf -outputdir fig -outputfile synteny-comp.lcal')

```

Plot comparison location of synteny blocks dlab vs SFL

```{r}

system('perl "scr/circos-0.66/bin/circos" -conf data/SYNTENY/circos-synt_dlab.conf -outputdir fig -outputfile synteny-comp.dlab')

```

Plot comparison location of synteny blocks lcal vs SFL

```{r}

system('perl "scr/circos-0.66/bin/circos" -conf data/SYNTENY/circos-synt_lcal.conf -outputdir fig -outputfile synteny-comp.dlab')

```

Plot comparison location of synteny blocks gacu vs SFL

```{r}

system('perl "scr/circos-0.66/bin/circos" -conf data/SYNTENY/circos-synt_gacu.conf -outputdir fig -outputfile synteny-comp.gacu')

```

Plot comparison location of synteny blocks onil vs SFL

```{r}

system('perl "scr/circos-0.66/bin/circos" -conf data/SYNTENY/circos-synt_onil.conf -outputdir fig -outputfile synteny-comp.onil')

```

Plot comparison location of synteny blocks tnig vs SFL

```{r}

system('perl "scr/circos-0.66/bin/circos" -conf data/SYNTENY/circos-synt_tnig.conf -outputdir fig -outputfile synteny-comp.tnig')

```

<<<<<<< Updated upstream
Plot comparison location of synteny blocks trub vs SFL

```{r}

system('perl "scr/circos-0.66/bin/circos" -conf data/SYNTENY/circos-synt_trub.conf -outputdir fig -outputfile synteny-comp.trub')

```


Plot synteny mapped loci (linkage maps):
=======
Plot synteny mapped loci (exposure studies):
>>>>>>> Stashed changes

```{r}

system('perl "scr/circos-0.66/bin/circos" -conf data/SYNTENY/circos-synt_loci-1.conf -outputdir fig -outputfile synteny-lociexp')


```

Plot synteny mapped loci (linkage maps):

```{r}

system('perl "scr/circos-0.66/bin/circos" -conf data/SYNTENY/circos-synt_loci-2.conf -outputdir fig -outputfile synteny-comp')

```