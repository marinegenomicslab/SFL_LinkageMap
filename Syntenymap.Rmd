---
title: "Comparative Genomics Southern Flounder"
output:
  html_notebook:
    code_folding: hide
    df_print: paged
    highlight: kate
    theme: flatly
    toc: yes
  html_document:
    toc: yes
---

```{r load libraries, message=FALSE, warning=FALSE}

knitr::opts_chunk$set(warning = FALSE, message = FALSE)

source("lib/libraries.R")
source("lib/ggplot.R")

```

# Load data

```{r}

# load map data
map <- read.table("data/SYNTENY/map.tab", header = TRUE)

# chrom lengths fish genomes
chrom <- read.table("data/SYNTENY/chr_lengths.txt", header = TRUE, stringsAsFactors = FALSE)

# load synteny data
syn_blocks <- read.table("data/SYNTENY/all.blocks.tab", header=TRUE)

# load synteny mapped loci
syn_loci <- read.table("data/SYNTENY/all.synteny.mapped.out", header=TRUE)

```

# Write input files

## Karyotype files

Create karyotype file for southern flounder consensus map.

```{r}

# determine length of each LG
by_lg <- group_by(map, LG) %>%
  top_n(1, POS)

# format karyotype file
kary <- ungroup(by_lg) %>%
    select(LG, POS) %>%
    unique() %>% # not sure why some LGs are duplicates?
    mutate(COLOR = "black") %>%
    mutate(id = paste("lg", LG, sep=''), 
           label = paste("LG", LG, sep=''),
           chr = "chr", 
           dash = "-", 
           start = "0", 
           end = as.integer(POS*500000), 
           color = "grey") %>%
    select(chr, dash, id, label, start, end, COLOR)

# output karyotype data file
write.table(kary, file = "data/SYNTENY/SFL.karyotype.txt", 
            sep = "\t", quote = FALSE, 
            row.names = FALSE, col.names = FALSE)

```

Create karyotype file for European seabass genome.

```{r}

# format file
kary <- chrom %>%
  filter(species == "dlab") %>%
  mutate(chr = "chr",
         dash = "-",
         id = chrom,
         label = chrom,
         start = "0", 
         end = length,
         color = "grey") %>%
  select(chr, dash, id, label, start, end, color)

# write karyotype track file
write.table(kary, "data/SYNTENY/dlab.karyotype.txt",
              sep = "\t", quote = FALSE, row.names = FALSE, col.names = FALSE)

```

Create karyotype file for stickleback (gacu):

```{r}

# create data frame with chromosome lengths
kary <- chrom %>%
  filter(species == "gacu") %>%
  mutate(chr = "chr",
         dash = "-",
         id = chrom,
         label = chrom,
         start = "0", 
         end = length,
         color = "grey") %>%
  select(chr, dash, id, label, start, end, color)

# write karyotype track file
write.table(kary, "data/SYNTENY/gacu.karyotype.txt",
            sep = "\t", quote = FALSE, row.names = FALSE, col.names = FALSE)
  
```

Asian Seabass (lcal)

```{r}

# create data frame with chromosome lengths
kary <- chrom %>%
  filter(species == "lcal") %>%
  mutate(chr = "chr",
         dash = "-",
         id = chrom,
         label = chrom,
         start = "0", 
         end = length,
         color = "grey") %>%
  select(chr, dash, id, label, start, end, color)

# write karyotype track file
write.table(kary, "data/SYNTENY/lcal.karyotype.txt",
            sep = "\t", quote = FALSE, row.names = FALSE, col.names = FALSE)

```

Nile tilapia (onil)

```{r}

# create data frame with chromosome lengths
kary <- chrom %>%
  filter(species == "onil") %>%
  mutate(chr = "chr",
         dash = "-",
         id = chrom,
         label = chrom,
         start = "0", 
         end = length,
         color = "grey") %>%
  select(chr, dash, id, label, start, end, color)

# write karyotype track file
write.table(kary, "data/SYNTENY/onil.karyotype.txt",
            sep = "\t", quote = FALSE, row.names = FALSE, col.names = FALSE)

```

spotted green puffer (tnig)

```{r}

# create data frame with chromosome lengths
kary <- chrom %>%
  filter(species == "tnig") %>%
  mutate(chr = "chr",
         dash = "-",
         id = chrom,
         label = chrom,
         start = "0", 
         end = length,
         color = "grey") %>%
  select(chr, dash, id, label, start, end, color)

# write karyotype track file
write.table(kary, "data/SYNTENY/tnig.karyotype.txt",
            sep = "\t", quote = FALSE, row.names = FALSE, col.names = FALSE)

```

Fugu (trub)

```{r}

# create data frame with chromosome lengths
kary <- chrom %>%
  filter(species == "trub") %>%
  mutate(chr = "chr",
         dash = "-",
         id = chrom,
         label = chrom,
         start = "0", 
         end = length,
         color = "grey") %>%
  select(chr, dash, id, label, start, end, color)

# write karyotype track file
write.table(kary, "data/SYNTENY/trub.karyotype.txt",
            sep = "\t", quote = FALSE, row.names = FALSE, col.names = FALSE)

```

## Tile track file

Create markers file with positions of mapped loci on each linkage group (chromosome).

```{r}

markers <- map %>%
    mutate(chr = paste("lg", LG, sep=''),
           start = as.integer(POS*500000), 
           end = as.integer(POS*500000)) %>%
    select(chr, start, end)

write.table(markers, file = "data/SYNTENY/markers.txt", 
            sep = "\t", quote = FALSE, 
            row.names = FALSE, col.names = FALSE)

```

Write tile track files for synteny blocks:

```{r}

# write tile track for synteny blocks for each species

species <- as.vector(unique(syn_blocks$COMP_SPECIES))

for (i in 1:length(species)) {
  
    tiles <- syn_blocks %>%
        filter(COMP_SPECIES == species[i]) %>%
        mutate(chr = paste("lg", MAP_LG, sep=''), 
               start = as.integer(MAP_START * 500000), 
               end = as.integer(MAP_STOP * 500000)) %>%
        select(chr, start, end)
    
    write.table(tiles, file = paste("data/SYNTENY/", species[i], ".synblocks", sep = ''), 
                sep = "\t", quote = FALSE, 
                row.names = FALSE, col.names = FALSE)
}

```

Write tile track files for synteny mapped loci:

```{r}
# Write a tile file for the synteny mapped loci

syn_loci <- syn_loci %>%
    mutate(chr = paste("lg", LG, sep=''), 
           start = as.integer(LEFT_POS * 500000), 
           end = as.integer(RIGHT_POS * 500000)) %>%
    select(chr, start, end)


write.table(syn_loci, file = "data/SYNTENY/all.synloci", 
            sep = "\t", quote = FALSE, 
            row.names = FALSE, col.names = FALSE)
```

## Write link files

Link file for synteny blocks dlab and SFL.

```{r}

# Format file
dlab_synblocks <- syn_blocks %>%
  filter(COMP_SPECIES == "dlab") %>%
  mutate(lg = paste("lg", MAP_LG, sep=''), 
         lgstart = as.integer(MAP_START * 500000),
         lgend = as.integer(MAP_STOP * 500000),
         chr = COMP_CHR,
         chrstart = COMP_START,
         chrend = COMP_END) %>%
  select(lg, lgstart, lgend, chr, chrstart, chrend)

write.table(dlab_synblocks, file = "data/SYNTENY/dlab.syn", 
                         sep = "\t", quote = FALSE, row.names = FALSE, col.names = FALSE)

```

Link file for synteny blocks gacu and SFL.

```{r}

# Format file
dlab_synblocks <- syn_blocks %>%
  filter(COMP_SPECIES == "gacu") %>%
  mutate(lg = paste("lg", MAP_LG, sep=''), 
         lgstart = as.integer(MAP_START * 500000),
         lgend = as.integer(MAP_STOP * 500000),
         chr = COMP_CHR,
         chrstart = COMP_START,
         chrend = COMP_END) %>%
  select(lg, lgstart, lgend, chr, chrstart, chrend) %>%
    group_by(lg)

write.table(dlab_synblocks, file = "data/SYNTENY/gacu.syn", 
                         sep = "\t", quote = FALSE, row.names = FALSE, col.names = FALSE)

```

Link file for synteny blocks lcal and SFL.

```{r}

# Format file
dlab_synblocks <- syn_blocks %>%
  filter(COMP_SPECIES == "lcal") %>%
  mutate(lg = paste("lg", MAP_LG, sep=''), 
         lgstart = as.integer(MAP_START * 500000),
         lgend = as.integer(MAP_STOP * 500000),
         chr = COMP_CHR,
         chrstart = COMP_START,
         chrend = COMP_END) %>%
  select(lg, lgstart, lgend, chr, chrstart, chrend) %>%
    group_by(lg)

write.table(dlab_synblocks, file = "data/SYNTENY/lcal.syn", 
                         sep = "\t", quote = FALSE, row.names = FALSE, col.names = FALSE)

```

Link file for synteny blocks onil and SFL.

```{r}

# Format file
dlab_synblocks <- syn_blocks %>%
  filter(COMP_SPECIES == "onil") %>%
  mutate(lg = paste("lg", MAP_LG, sep=''), 
         lgstart = as.integer(MAP_START * 500000),
         lgend = as.integer(MAP_STOP * 500000),
         chr = COMP_CHR,
         chrstart = COMP_START,
         chrend = COMP_END) %>%
  select(lg, lgstart, lgend, chr, chrstart, chrend) %>%
    group_by(lg)

write.table(dlab_synblocks, file = "data/SYNTENY/onil.syn", 
                         sep = "\t", quote = FALSE, row.names = FALSE, col.names = FALSE)

```

Link file for synteny blocks tnig and SFL.

```{r}

# Format file
dlab_synblocks <- syn_blocks %>%
  filter(COMP_SPECIES == "tnig") %>%
  mutate(lg = paste("lg", MAP_LG, sep=''), 
         lgstart = as.integer(MAP_START * 500000),
         lgend = as.integer(MAP_STOP * 500000),
         chr = COMP_CHR,
         chrstart = COMP_START,
         chrend = COMP_END) %>%
  select(lg, lgstart, lgend, chr, chrstart, chrend) %>%
    group_by(lg)

write.table(dlab_synblocks, file = "data/SYNTENY/tnig.syn", 
                         sep = "\t", quote = FALSE, row.names = FALSE, col.names = FALSE)

```

Link file for synteny blocks trub and SFL.

```{r}

# Format file
dlab_synblocks <- syn_blocks %>%
  filter(COMP_SPECIES == "trub") %>%
  mutate(lg = paste("lg", MAP_LG, sep=''), 
         lgstart = as.integer(MAP_START * 500000),
         lgend = as.integer(MAP_STOP * 500000),
         chr = COMP_CHR,
         chrstart = COMP_START,
         chrend = COMP_END) %>%
  select(lg, lgstart, lgend, chr, chrstart, chrend) %>%
    group_by(lg)

write.table(dlab_synblocks, file = "data/SYNTENY/trub.syn", 
                         sep = "\t", quote = FALSE, row.names = FALSE, col.names = FALSE)

```


# Run circos:

Plot synteny blocks (inside) and SNP loci (outside):

```{r}

system('perl "scr/circos-0.66/bin/circos" -conf data/SYNTENY/circos-synt_blocks.conf -outputdir fig -outputfile synteny-blocks')

```

Plot comparison location of synteny blocks lcal vs SFL

```{r}

system('perl "scr/circos-0.66/bin/circos" -conf data/SYNTENY/circos-synt_lcal.conf -outputdir fig -outputfile synteny-comp.lcal')

```

Plot comparison location of synteny blocks dlab vs SFL

```{r}

system('perl "scr/circos-0.66/bin/circos" -conf data/SYNTENY/circos-synt_dlab.conf -outputdir fig -outputfile synteny-comp.dlab')

```

Plot comparison location of synteny blocks lcal vs SFL

```{r}

system('perl "scr/circos-0.66/bin/circos" -conf data/SYNTENY/circos-synt_lcal.conf -outputdir fig -outputfile synteny-comp.dlab')

```

Plot comparison location of synteny blocks gacu vs SFL

```{r}

system('perl "scr/circos-0.66/bin/circos" -conf data/SYNTENY/circos-synt_gacu.conf -outputdir fig -outputfile synteny-comp.gacu')

```

Plot comparison location of synteny blocks onil vs SFL

```{r}

system('perl "scr/circos-0.66/bin/circos" -conf data/SYNTENY/circos-synt_onil.conf -outputdir fig -outputfile synteny-comp.onil')

```

Plot comparison location of synteny blocks tnig vs SFL

```{r}

system('perl "scr/circos-0.66/bin/circos" -conf data/SYNTENY/circos-synt_tnig.conf -outputdir fig -outputfile synteny-comp.tnig')

```

Plot comparison location of synteny blocks trub vs SFL

```{r}

system('perl "scr/circos-0.66/bin/circos" -conf data/SYNTENY/circos-synt_trub.conf -outputdir fig -outputfile synteny-comp.trub')

```


Plot synteny mapped loci (linkage maps):

```{r}



```


Plot synteny mapped loci (exposure studies):

```{r}



```

